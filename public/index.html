<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personen Übersicht</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <a href="index.html">
            <img class="logo" src="logo2.png" alt="Logo" />
        </a>
        <h1>Justus Angels</h1>
        <input type="text" id="searchInput" class="search-bar" placeholder="Suchen..." />
        <input type="number" id="minAge" class="filter-input" placeholder="Mindestalter" />
        <input type="number" id="maxAge" class="filter-input" placeholder="Maximalalter" />
        <button id="filterButton" class="filter-button">Filter</button>
        <a href="add-person.html" class="add-person-button">Add Person</a>
        <a href="add-category.html" class="add-category-button">Add Category</a>
        <div id="auth">
            <span id="loggedInUser"></span>
            <button id="logoutButton" style="display: none;">Logout</button>
            <a href="login.html" id="loginButton" class="login-button">Login</a>
            <a href="register.html" id="registerButton" class="register-button">Registrieren</a>
            <a href="add-category.html" class="add-category-button" style="display: none;">Add Category</a>

        </div>
    </header>

    <main>
        <div id="peopleGrid" class="people-grid">
            <!-- Personen werden hier dynamisch geladen -->
        </div>
    </main>

    <footer>
        <p><a href="Impressum.html">Impressum</a> | <a href="Kontakt.html">Kontakt</a></p>
    </footer>

    <script>
        const apiUrl = '/api/person';
    
        // Token nur einmal deklarieren
        const token = localStorage.getItem('token');
    
        // Sichtbarkeit von "Add Category"-Button basierend auf Login-Status
        if (token) {
            document.querySelector('.add-category-button').style.display = 'inline-block';
        } else {
            document.querySelector('.add-category-button').style.display = 'none';
        }
    
        async function loadPersons() {
            try {
                const response = await fetch(apiUrl);
                const persons = await response.json();
                const peopleGrid = document.getElementById('peopleGrid');
                peopleGrid.innerHTML = '';
    
                persons.forEach(person => {
                    const categories = person.categories ? person.categories.join(', ') : 'Keine Kategorien';
                    const personCard = `
                        <div class="person-card-container">
                            <a href="person.html?id=${person.id}" class="person-card">
                                <div class="person-image-container">
                                    <img src="${person.image}" alt="Foto von ${person.name}" class="person-image" />
                                </div>
                                <div class="person-info">
                                    <h2>${person.name}</h2>
                                    <p><strong>Alter:</strong> ${person.age}</p>
                                    <p><strong>Größe:</strong> ${person.height} cm</p>
                                    <p><strong>Kategorien:</strong> ${categories}</p>
                                </div>
                            </a>
                            <div class="card-actions">
                                ${token ? `
                                    <a href="edit-person.html?id=${person.id}" class="edit-button">Bearbeiten</a>
                                    <button class="delete-button" data-id="${person.id}">Löschen</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    peopleGrid.innerHTML += personCard;
                });
            } catch (error) {
                console.error('Fehler beim Laden der Personen:', error);
                alert('Personen konnten nicht geladen werden.');
            }
        }
    
        document.addEventListener('click', async (event) => {
            if (event.target.classList.contains('delete-button')) {
                const personId = event.target.getAttribute('data-id');
                if (confirm('Möchten Sie diese Person wirklich löschen?')) {
                    try {
                        await fetch(`${apiUrl}/${personId}`, {
                            method: 'DELETE',
                            headers: { Authorization: `Bearer ${token}` },
                        });
                        loadPersons();
                    } catch (error) {
                        console.error('Fehler beim Löschen der Person:', error);
                        alert('Person konnte nicht gelöscht werden.');
                    }
                }
            }
        });
    
        loadPersons();
    </script>
    
</body>
</html>
