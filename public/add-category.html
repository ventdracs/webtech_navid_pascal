<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kategorien verwalten</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <a href="index.html">
            <img class="logo" src="logo2.png" alt="Logo" />
        </a>
        <h1>Justus Angels</h1>
        <input type="text" id="searchInput" class="search-bar" placeholder="Suchen..." />
        <input type="number" id="minAge" class="filter-input" placeholder="Mindestalter" />
        <input type="number" id="maxAge" class="filter-input" placeholder="Maximalalter" />
        <button id="filterButton" class="filter-button">Filter</button>
        <a href="add-person.html" class="add-person-button">Add Person</a>
        <a href="add-category.html" class="add-category-button" style="display: none;">Add Category</a>
        <div id="auth">
            <span id="loggedInUser"></span>
            <button id="logoutButton" style="display: none;">Logout</button>
            <a href="login.html" id="loginButton" class="login-button">Login</a>
            <a href="register.html" id="registerButton" class="register-button">Registrieren</a>
        </div>
    </header>

    <main>
        <form id="addCategoryForm" class="category-form">
            <h2>Neue Kategorie Hinzufügen</h2>
            <input type="text" id="newCategoryName" placeholder="Kategoriename" required />
            <button type="submit">Hinzufügen</button>
        </form>

        <div id="categoryList" class="category-grid">
            <!-- Kategorien werden hier dynamisch geladen -->
        </div>
    </main>

    <footer>
        <p><a href="Impressum.html">Impressum</a> | <a href="Kontakt.html">Kontakt</a></p>
    </footer>

    <script>
        const categoryApiUrl = '/api/categories';
    
        // Login-Status beim Laden der Seite prüfen
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (token) {
                const username = localStorage.getItem('username');
                document.getElementById('loggedInUser').textContent = `Hallo, ${username}`;
                document.getElementById('logoutButton').style.display = 'block';
                document.getElementById('loginButton').style.display = 'none';
                document.getElementById('registerButton').style.display = 'none';
                document.querySelector('.add-category-button').style.display = 'inline-block';
    
                const addCategoryButton = document.querySelector('.add-category-button');
                if (addCategoryButton) {
                    addCategoryButton.style.display = 'inline-block';
                }
            } else {
                document.getElementById('loginButton').style.display = 'block';
                document.getElementById('registerButton').style.display = 'block';
            }
        });
    
        // Kategorien laden
        async function loadCategories() {
    try {
        const response = await fetch(categoryApiUrl);
        const categories = await response.json();
        const categoryList = document.getElementById('categoryList');
        categoryList.innerHTML = '';

        categories.forEach(category => {
            const categoryCard = document.createElement('div');
            categoryCard.className = 'person-card';
            categoryCard.innerHTML = `
                <h2>${category.name}</h2>
                <p>Anzahl der Personen: ${category.count}</p>
                ${localStorage.getItem('token') ? `
                <button class="edit-button" data-id="${category.id}">Bearbeiten</button>
                <button class="delete-button" data-id="${category.id}">Löschen</button>
                ` : ''}
            `;
            categoryList.appendChild(categoryCard);
        });
    } catch (error) {
        console.error('Fehler beim Laden der Kategorien:', error);
        alert('Kategorien konnten nicht geladen werden.');
    }
}
    
        // Event-Listener für Hinzufügen, Bearbeiten und Löschen
        document.getElementById('addCategoryForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const newCategoryName = document.getElementById('newCategoryName').value.trim();
    
            if (!newCategoryName) {
                alert('Bitte einen Kategorienamen eingeben.');
                return;
            }
    
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Sie müssen eingeloggt sein, um Kategorien hinzuzufügen.');
                window.location.href = 'login.html';
                return;
            }
    
            try {
                await fetch(categoryApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({ name: newCategoryName }),
                });
    
                document.getElementById('newCategoryName').value = '';
                loadCategories();
            } catch (error) {
                console.error('Fehler beim Hinzufügen der Kategorie:', error);
                alert('Kategorie konnte nicht hinzugefügt werden.');
            }
        });
    
        document.addEventListener('click', async (event) => {
            if (event.target.classList.contains('delete-button')) {
                const categoryId = event.target.getAttribute('data-id');
                if (confirm('Möchten Sie diese Kategorie wirklich löschen?')) {
                    try {
                        const token = localStorage.getItem('token');
                        await fetch(`${categoryApiUrl}/${categoryId}`, {
                            method: 'DELETE',
                            headers: { Authorization: `Bearer ${token}` },
                        });
                        loadCategories();
                    } catch (error) {
                        console.error('Fehler beim Löschen der Kategorie:', error);
                        alert('Kategorie konnte nicht gelöscht werden.');
                    }
                }
            }
    
            if (event.target.classList.contains('edit-button')) {
                const categoryId = event.target.getAttribute('data-id');
                const newCategoryName = prompt('Neuer Name für die Kategorie:');
                if (newCategoryName) {
                    try {
                        const token = localStorage.getItem('token');
                        await fetch(`${categoryApiUrl}/${categoryId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                Authorization: `Bearer ${token}`,
                            },
                            body: JSON.stringify({ name: newCategoryName }),
                        });
                        loadCategories();
                    } catch (error) {
                        console.error('Fehler beim Bearbeiten der Kategorie:', error);
                        alert('Kategorie konnte nicht bearbeitet werden.');
                    }
                }
            }
        });
    
        // Event-Listener für Suchfeld
        document.getElementById('searchInput').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                const searchTerm = event.target.value.trim();
                if (searchTerm) {
                    const queryParams = new URLSearchParams({ search: searchTerm });
                    window.location.href = `search-results.html?${queryParams}`;
                } else {
                    alert('Bitte geben Sie einen Suchbegriff ein.');
                }
            }
        });

        // Logout-Button Funktionalität
document.getElementById('logoutButton').addEventListener('click', () => {
    // Token und Benutzername aus localStorage entfernen
    localStorage.removeItem('token');
    localStorage.removeItem('username');
    
    // Seite neu laden, um den Login-Status zu aktualisieren
    window.location.reload();
});
    
        // Kategorien laden beim Start
        loadCategories();
    </script>
    
    
</body>
</html>
